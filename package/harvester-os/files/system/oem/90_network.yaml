name: "Network configuration"
stages:
  initramfs:
    # We will manually update the /etc/resolv.conf so stop netconfig from modifying it
    - name: Disable NETCONFIG_DNS_POLICY for PXE installation
      if: cat /proc/cmdline | grep -q "harvester.install.automatic=true"
      commands:
      - |
        echo "Disable netconfig DNS configuration"
        sed -i 's/NETCONFIG_DNS_POLICY="auto"/NETCONFIG_DNS_POLICY=""/g' /etc/sysconfig/network/config
  # dracut's ifcfg module runs at the very end of initrd process, after cOS' "rootfs" and "initramfs" stages,
  # so we need to copy these ifcfg files at the boot stage
  boot:
    - name: Copy ifcfg generated by dracut
      if: cat /proc/cmdline | grep -q "harvester.install.automatic=true"
      commands:
      - |
        echo "Copy ifcfg generated by dracut to sysroot"
        cp /run/initramfs/state/etc/sysconfig/network-scripts/* /etc/sysconfig/network/

      # https://bugzilla.opensuse.org/show_bug.cgi?id=1193518
      - |
        echo "Fix incorrectly set BOOTPROTO=none issue for DHCP interfaces"
        for file in /etc/sysconfig/network/ifcfg-*; do
          if grep 'IPADDR=""' $file > /dev/null 2>&1; then
            echo "Set BOOTPROTO=dhcp for $file"
            sed -i 's/BOOTPROTO=none/BOOTPROTO=dhcp/g' $file
          fi
        done

    - name: Copy resolv.conf generated by dracut
      if: cat /proc/cmdline | grep -q "harvester.install.automatic=true"
      commands:
      - |
        generated_resolv="/run/initramfs/state/etc/resolv.conf"
        if [ -f $generated_resolv ]; then
          cp $generated_resolv /etc/resolv.conf
          echo "Copied $generated_resolv to /etc/resolv.conf"
        else
          # ifcfg module does not recognize the net.*.resolv.conf.ipv4 because of those ipv4 suffix.
          # We need to gather them by ourselves
          for i in /run/initramfs/net.*.resolv.conf*; do
            [ -f "$i" ] && cat "$i"
          done | sort -u > /etc/resolv.conf
          echo "/etc/resolv.conf is generated from each interface's resolv.conf"
        fi
  network:
    - name: Bring up interfaces
      commands:
      - |
        for i in /sys/class/net/{eth*,en*,ib*}; do
          [ -e $i ] || continue
          ip link set $(basename $i) up;
        done