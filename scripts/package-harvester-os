#!/bin/bash -e

TOP_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." &> /dev/null && pwd )"
DIST_DIR="${TOP_DIR}/dist"
SCRIPTS_DIR="${TOP_DIR}/scripts"
PACKAGE_HARVESTER_OS_DIR="${TOP_DIR}/package/harvester-os"

source ${SCRIPTS_DIR}/version

BASE_OS_IMAGE="rancher/harvester-os:dev-head"
HARVESTER_OS_IMAGE=rancher/harvester-os:$VERSION

cd ${PACKAGE_HARVESTER_OS_DIR}
docker build --pull \
	--build-arg BASE_OS_IMAGE="${BASE_OS_IMAGE}" \
	--build-arg CACHEBUST="$(date)" \
	-t ${HARVESTER_OS_IMAGE} .

# build ISO
[ -d iso ] && yq e ".overlay.isoimage = \"$(pwd)/iso\"" iso.yaml -i
luet-makeiso iso.yaml --image "${HARVESTER_OS_IMAGE}" --output ${DIST_DIR}/harvester
