#!/bin/bash
set -e

source $(dirname $0)/version

cd $(dirname $0)/..

echo "Start building ISO"

K3S_VERSION=v1.19.4+k3s1
K3S_IMAGE_URL=https://raw.githubusercontent.com/rancher/k3s/${K3S_VERSION}/scripts/airgap/image-list.txt
LONGHORN_VERSION=v1.0.2
LONGHORN_IMAGE_URL=https://raw.githubusercontent.com/longhorn/longhorn/${LONGHORN_VERSION}/deploy/longhorn-images.txt
OFFLINE_BUILD="1"

# Prepare Harvester, Longhorn charts
mkdir -p k3os/images/70-iso/charts
harvester_chart_path=../harvester/deploy/charts/harvester
if [ ! -d ${harvester_chart_path} ];then
    git clone --branch master --single-branch --depth 1 https://github.com/rancher/harvester.git /tmp/harvester
    harvester_chart_path=/tmp/harvester/deploy/charts/harvester
fi
helm package ${harvester_chart_path} -d k3os/images/70-iso/charts
git clone --branch ${LONGHORN_VERSION} --single-branch --depth 1 https://github.com/rancher/longhorn.git /tmp/longhorn
helm package /tmp/longhorn/chart -d k3os/images/70-iso/charts

# Manifests
mkdir -p k3os/images/70-iso/manifests
cp scripts/manifests/* k3os/images/70-iso/manifests

# Offline docker images
image_list_file='scripts/image-list.txt'
curl ${K3S_IMAGE_URL}>>${image_list_file}
curl ${LONGHORN_IMAGE_URL}>>${image_list_file}

output_image_tar_file="k3os/images/70-iso/harvester-images.tar"
if [ -n "${OFFLINE_BUILD}" ] && [ ! -f $output_image_tar_file.zst ]; then
  images=$(cat "${image_list_file}")
  xargs -n1 docker pull <<< "${images}"
  docker save ${images} -o ${output_image_tar_file}

  zstd --rm ${output_image_tar_file} -o ${output_image_tar_file}.zst
fi

# Remaster k3os
cd k3os
# Update vendors
export GO111MODULE=on
go mod edit -replace=github.com/nsf/termbox-go=github.com/gitlawr/termbox-go@v0.0.0-20201103025537-250e644d56a6
go mod edit -replace=github.com/rancher/harvester-installer=../
go get
go mod vendor
# make ISO
cd scripts
./default
mkdir -p ../../dist/artifacts
mv ../dist/artifacts/* ../../dist/artifacts
for file in `find ../../dist/artifacts -type f -name '*.iso'`; do mv "$file" "${file/k3os/harvester}"; done
